"use strict";(()=>{var e={};e.id=738,e.ids=[738],e.modules={8013:e=>{e.exports=require("mongodb")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},1764:e=>{e.exports=require("util")},4499:(e,t,n)=>{n.r(t),n.d(t,{originalPathname:()=>w,patchFetch:()=>P,requestAsyncStorage:()=>m,routeModule:()=>g,serverHooks:()=>h,staticGenerationAsyncStorage:()=>C});var o={};n.r(o),n.d(o,{OPTIONS:()=>A,POST:()=>d});var s=n(9303),r=n(8716),a=n(670),l=n(7070),u=n(2021),i=n(5029),p=n(9544),c=n(9576);async function d(e){try{let{userAddress:t,gameTitle:n,title:o,content:s,tags:r,description:a}=await e.json();if(!t||!n||!o||!s)return console.warn("[Content Upload API] 缺少必需参数"),l.NextResponse.json({success:!1,error:"Missing required parameters: userAddress, gameTitle, title, content"},{status:400});if(!(0,i.At)(t))return console.warn("[Content Upload API] 无效的钱包地址:",t),l.NextResponse.json({success:!1,error:"Invalid user address format"},{status:400});let d=(0,i.f0)(t);if("string"!=typeof s||0===s.trim().length)return console.warn("[Content Upload API] 内容无效"),l.NextResponse.json({success:!1,error:"Content must be a non-empty string"},{status:400});if(s.length>5e4)return console.warn("[Content Upload API] 内容过长"),l.NextResponse.json({success:!1,error:"Content must be less than 50000 characters"},{status:400});if("string"!=typeof o||0===o.trim().length||o.length>500)return console.warn("[Content Upload API] 标题无效"),l.NextResponse.json({success:!1,error:"Title must be a non-empty string and less than 500 characters"},{status:400});console.log("[Content Upload API] 收到请求 | 用户:",d,"| 游戏:",n);let A=(0,c.Z)();console.log("[Content Upload API] 存储内容到数据库...");let g=await (0,u.uD)(),m=new Date;await g.collection("gameContent").insertOne({contentId:A,userAddress:d,gameTitle:n,title:o,content:s,tags:r||[],description:a||"",status:"approved",queryCount:0,rewardAmount:"1",rewardStatus:"pending",rewardTxHash:null,createdAt:m,updatedAt:m}),console.log("[Content Upload API] 内容已存储，ID:",A),console.log("[Content Upload API] 准备转账 1 GAME 代币...");let C=null;try{let e=process.env.GAME_TOKEN_ADDRESS,t=(0,p.r0)("1");if(e){let n=(0,p.G4)();C=(await n.transferERC20(e,d,t)).transactionHash,console.log("[Content Upload API] 转账成功，TX Hash:",C),await g.collection("gameContent").updateOne({contentId:A},{$set:{rewardStatus:"distributed",rewardTxHash:C,updatedAt:new Date}}),console.log("[Content Upload API] 数据库已更新，转账状态: distributed")}else console.warn("[Content Upload API] GAME_TOKEN_ADDRESS 环境变量未配置，跳过转账")}catch(e){console.error("[Content Upload API] 转账失败:",e)}return l.NextResponse.json({success:!0,contentId:A,rewardTxHash:C,message:C?"内容上传成功，已获得 1 GAME 代币奖励":"内容上传成功（代币奖励处理中）"},{status:201})}catch(e){return console.error("[Content Upload API] 处理请求失败:",e),l.NextResponse.json({success:!1,error:"Failed to upload content",details:e instanceof Error?e.message:"Unknown error"},{status:500})}}async function A(){return new l.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}let g=new s.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/content/upload/route",pathname:"/api/content/upload",filename:"route",bundlePath:"app/api/content/upload/route"},resolvedPagePath:"/Users/daniel/Code/10_project/Game/server/app/api/content/upload/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:C,serverHooks:h}=g,w="/api/content/upload/route";function P(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:C})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),o=t.X(0,[789,878,885],()=>n(4499));module.exports=o})();