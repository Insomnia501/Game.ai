"use strict";exports.id=885,exports.ids=[885],exports.modules={5029:(o,e,n)=>{function t(o){return/^0x[a-fA-F0-9]{40}$/.test(o)}function i(o){if(!t(o))throw Error("Invalid address format");return o.toLowerCase()}n.d(e,{At:()=>t,f0:()=>i})},9544:(o,e,n)=>{n.d(e,{G4:()=>p,mb:()=>w,r0:()=>u});var t=n(7856),i=n(8165),r=n(6772),a=n(7618),c=n(2458),l=n(6103),s=n(5392);let d=["function transfer(address to, uint256 amount) public returns (bool)","function balanceOf(address account) public view returns (uint256)","function approve(address spender, uint256 amount) public returns (bool)","function allowance(address owner, address spender) public view returns (uint256)"],g=["function depositDividend(uint256 amount) external","function claimDividend() external nonReentrant returns (uint256 claimable)","function getPendingDividend(address user) external view returns (uint256)","function getUserDividendInfo(address user) external view returns (uint256 pending, uint256 claimed, uint256 gameBalance)","function getPoolStats() external view returns (uint256 _totalDividendPool, uint256 _totalClaimed, uint256 _totalPending, uint256 _totalDividendPerShare)"];class h{provider;signer;rpcUrl;privateKey;constructor(o){this.rpcUrl=o.rpcUrl,this.privateKey=o.privateKey,this.provider=new t.r(o.rpcUrl),this.signer=new i.w5(o.privateKey,this.provider)}async callJsonRpc(o,e){let n=await fetch(this.rpcUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({jsonrpc:"2.0",id:Date.now(),method:o,params:e})}),t=await n.json();if(t.error)throw Error(`JSON-RPC Error: ${t.error.message}`);return t.result}async transferERC20(o,e,n){try{let t,s;if(console.log("[Blockchain] 准备转账 ERC20 代币"),console.log("[Blockchain] 代币地址:",o),console.log("[Blockchain] 接收地址:",e),console.log("[Blockchain] 转账数量:",n),!r.UJ(o))throw Error("Invalid token address format");if(!r.UJ(e))throw Error("Invalid recipient address format");console.log("[Blockchain] 使用 JSON-RPC 构建转账交易...");let g=new i.w5(this.privateKey);console.log("[Blockchain] 通过原始 JSON-RPC 获取交易数据...");try{let o=await this.callJsonRpc("eth_getTransactionCount",[g.address,"latest"]);t=parseInt(o,16),console.log("[Blockchain] 获取 Nonce:",t)}catch(o){console.warn("[Blockchain] 无法获取 Nonce，使用默认值 0"),t=0}try{let o=await this.callJsonRpc("eth_gasPrice",[]);s=a.O$.from(o),console.log("[Blockchain] 获取 Gas Price:",c.bM(s,"gwei"),"gwei")}catch(o){console.warn("[Blockchain] 无法获取 Gas Price，使用默认值 1 gwei"),s=c.vz("1","gwei")}let h=a.O$.from("100000");console.log("[Blockchain] 交易参数:"),console.log("  • Nonce:",t),console.log("  • Gas Price:",c.bM(s,"gwei"),"gwei"),console.log("  • Gas Limit:",h.toString());let p=new l.vU(d).encodeFunctionData("transfer",[e,n]),u={to:o,from:g.address,nonce:t,gasLimit:h,gasPrice:s,data:p};console.log("[Blockchain] 签名交易...");let w=await g.signTransaction(u);console.log("[Blockchain] 发送签名的交易到网络...");let v=await this.callJsonRpc("eth_sendRawTransaction",[w]);console.log("[Blockchain] 交易已发送，Hash:",v),console.log("[Blockchain] 等待交易确认...");let m=null;for(let o=0;o<30;o++){try{let o=await this.callJsonRpc("eth_getTransactionReceipt",[v]);if(o){m=o,console.log("[Blockchain] 交易已确认，区块号:",parseInt(o.blockNumber,16));break}}catch(e){console.warn("[Blockchain] 等待确认中...",o+1)}await new Promise(o=>setTimeout(o,2e3))}return{transactionHash:v,blockNumber:m?parseInt(m.blockNumber,16):void 0}}catch(o){throw console.error("[Blockchain] 转账失败:",o.message),o}}async getERC20Balance(o,e){try{let n=new s.CH(o,d,this.provider);return(await n.balanceOf(e)).toString()}catch(o){throw console.error("[Blockchain] 查询余额失败:",o),o}}async getSignerAddress(){return await this.signer.getAddress()}async getNetworkInfo(){let o=await this.provider.getNetwork();return{chainId:o.chainId,name:o.name}}async updateGameDividendPool(o,e){try{let n,t;if(console.log("[Blockchain] 准备调用 GameDividendPool.depositDividend()"),console.log("[Blockchain] 分红池地址:",o),console.log("[Blockchain] 分红金额:",e),!r.UJ(o))throw Error("Invalid dividend pool address format");let s=new i.w5(this.privateKey);try{let o=await this.callJsonRpc("eth_getTransactionCount",[s.address,"latest"]);n=parseInt(o,16),console.log("[Blockchain] 获取 Nonce:",n)}catch(o){console.warn("[Blockchain] 无法获取 Nonce，使用默认值 0"),n=0}try{let o=await this.callJsonRpc("eth_gasPrice",[]);t=a.O$.from(o),console.log("[Blockchain] 获取 Gas Price:",c.bM(t,"gwei"),"gwei")}catch(o){console.warn("[Blockchain] 无法获取 Gas Price，使用默认值 1 gwei"),t=c.vz("1","gwei")}let h=a.O$.from("150000");console.log("[Blockchain] 交易参数:"),console.log("  • Nonce:",n),console.log("  • Gas Price:",c.bM(t,"gwei"),"gwei"),console.log("  • Gas Limit:",h.toString()),console.log("[Blockchain] 构建 approve 交易...");let p=process.env.VIRTUAL_TOKEN_ADDRESS;if(!p)throw Error("VIRTUAL_TOKEN_ADDRESS environment variable is not set");let u=new l.vU(d).encodeFunctionData("approve",[o,e]),w={to:p,from:s.address,nonce:n,gasLimit:a.O$.from("100000"),gasPrice:t,data:u};console.log("[Blockchain] 签名 approve 交易...");let v=await s.signTransaction(w);console.log("[Blockchain] 发送 approve 交易...");let m=await this.callJsonRpc("eth_sendRawTransaction",[v]);console.log("[Blockchain] Approve 交易已发送，Hash:",m),console.log("[Blockchain] 等待 approve 交易确认...");for(let o=0;o<30;o++){try{if(await this.callJsonRpc("eth_getTransactionReceipt",[m])){console.log("[Blockchain] Approve 交易已确认");break}}catch(e){console.warn("[Blockchain] 等待 approve 确认中...",o+1)}await new Promise(o=>setTimeout(o,2e3))}console.log("[Blockchain] 构建 depositDividend 交易...");let f=new l.vU(g).encodeFunctionData("depositDividend",[e]),B={to:o,from:s.address,nonce:n+1,gasLimit:a.O$.from("150000"),gasPrice:t,data:f};console.log("[Blockchain] 签名 depositDividend 交易...");let k=await s.signTransaction(B);console.log("[Blockchain] 发送 depositDividend 交易...");let D=await this.callJsonRpc("eth_sendRawTransaction",[k]);console.log("[Blockchain] Deposit 交易已发送，Hash:",D),console.log("[Blockchain] 等待 depositDividend 交易确认...");let P=null;for(let o=0;o<30;o++){try{let o=await this.callJsonRpc("eth_getTransactionReceipt",[D]);if(o){P=o,console.log("[Blockchain] Deposit 交易已确认，区块号:",parseInt(o.blockNumber,16));break}}catch(e){console.warn("[Blockchain] 等待 deposit 确认中...",o+1)}await new Promise(o=>setTimeout(o,2e3))}return{transactionHash:D,blockNumber:P?parseInt(P.blockNumber,16):void 0}}catch(o){throw console.error("[Blockchain] 分红更新失败:",o.message),o}}async getUserDividendInfo(o,e){try{if(console.log("[Blockchain] 查询用户分红信息"),console.log("[Blockchain] 分红池地址:",o),console.log("[Blockchain] 用户地址:",e),!r.UJ(o))throw Error("Invalid dividend pool address format");if(!r.UJ(e))throw Error("Invalid user address format");let n=new s.CH(o,g,this.provider),t=await n.getUserDividendInfo(e);return console.log("[Blockchain] 用户分红信息查询成功"),console.log("[Blockchain] 待提取分红:",t.pending.toString()),console.log("[Blockchain] 已提取分红:",t.claimed.toString()),console.log("[Blockchain] GAME 余额:",t.gameBalance.toString()),{pending:t.pending.toString(),claimed:t.claimed.toString(),gameBalance:t.gameBalance.toString()}}catch(o){throw console.error("[Blockchain] 查询分红信息失败:",o.message),o}}async getDividendPoolStats(o){try{if(console.log("[Blockchain] 查询分红池统计信息"),!r.UJ(o))throw Error("Invalid dividend pool address format");let e=new s.CH(o,g,this.provider),n=await e.getPoolStats();return console.log("[Blockchain] 分红池统计信息查询成功"),{totalDividendPool:n._totalDividendPool.toString(),totalClaimed:n._totalClaimed.toString(),totalPending:n._totalPending.toString(),totalDividendPerShare:n._totalDividendPerShare.toString()}}catch(o){throw console.error("[Blockchain] 查询分红池统计失败:",o.message),o}}}function p(){let o=process.env.BASE_SEPOLIA_RPC_URL,e=process.env.DEPLOYER_PRIVATE_KEY,n=parseInt(process.env.CHAIN_ID||"84532");if(!o)throw Error("BASE_SEPOLIA_RPC_URL environment variable is not set");if(!e)throw Error("DEPLOYER_PRIVATE_KEY environment variable is not set");return new h({rpcUrl:o,privateKey:e,chainId:n})}function u(o,e=18){return c.vz(o,e).toString()}function w(o,e=18){return c.bM(o,e)}},2021:(o,e,n)=>{n.d(e,{uD:()=>l});var t=n(8013);let i=process.env.MONGODB_URI||"mongodb://localhost:27017",r=process.env.MONGODB_DB_NAME||"game-ai",a=null,c=null;async function l(){if(a&&c)return console.log("[MongoDB] 使用缓存连接"),c;try{console.log("[MongoDB] 正在连接...");let o=new t.MongoClient(i,{maxPoolSize:10,minPoolSize:2,maxIdleTimeMS:6e4});await o.connect(),console.log("[MongoDB] 连接成功");let e=o.db(r);return a=o,c=e,e}catch(o){throw console.error("[MongoDB] 连接失败:",o),o}}},9576:(o,e,n)=>{n.d(e,{Z:()=>s});var t=n(4770),i=n.n(t);let r={randomUUID:i().randomUUID},a=new Uint8Array(256),c=a.length,l=[];for(let o=0;o<256;++o)l.push((o+256).toString(16).slice(1));let s=function(o,e,n){if(r.randomUUID&&!e&&!o)return r.randomUUID();let t=(o=o||{}).random||(o.rng||function(){return c>a.length-16&&(i().randomFillSync(a),c=0),a.slice(c,c+=16)})();if(t[6]=15&t[6]|64,t[8]=63&t[8]|128,e){n=n||0;for(let o=0;o<16;++o)e[n+o]=t[o];return e}return function(o,e=0){return l[o[e+0]]+l[o[e+1]]+l[o[e+2]]+l[o[e+3]]+"-"+l[o[e+4]]+l[o[e+5]]+"-"+l[o[e+6]]+l[o[e+7]]+"-"+l[o[e+8]]+l[o[e+9]]+"-"+l[o[e+10]]+l[o[e+11]]+l[o[e+12]]+l[o[e+13]]+l[o[e+14]]+l[o[e+15]]}(t)}}};